services:
  # Shared Redis instance for all services
  redis:
    container_name: shared_redis
    image: redis:7.4-alpine
    command: redis-server --appendonly yes
    restart: always
    ports:
      - 6379:6379
    volumes:
      - redis_data:/data
    networks:
      - redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  mariadb:
    container_name: mariadb
    image: mariadb:11
    restart: always
    stop_grace_period: 5s
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined
    command: --innodb-buffer-pool-size=512M --transaction-isolation=READ-COMMITTED --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --max-connections=512 --innodb-rollback-on-timeout=OFF --innodb-lock-wait-timeout=120
    volumes:
      - mariadb:/var/lib/mysql
    networks:
      - mariadb
    environment:
      MARIADB_AUTO_UPGRADE: "1"
      MARIADB_INITDB_SKIP_TZINFO: "1"
      MARIADB_DATABASE: "default"
      MARIADB_USER: ${MARIADB_USER}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}

  adminer:
    container_name: adminer
    image: adminer
    restart: always
    ports:
      - 23499:8080
    environment:
      ADMINER_DEFAULT_SERVER: mariadb
    depends_on:
      - mariadb
    networks:
      - mariadb

  # Custom PostgreSQL with PostGIS, pgvector, and other extensions
  postgre:
    container_name: postgre_db
    build:
      context: ./postgresql
      dockerfile: Dockerfile
    image: archivum-postgre:17
    restart: always
    ports:
      - 5432:5432
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=default
    networks:
      - postgre
      - tandoor
    volumes:
      - postgre:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  pgadmin:
    container_name: pgadmin
    image: dpage/pgadmin4
    restart: always
    depends_on:
      - postgre
    ports:
      - 15433:80
    environment:
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_DEFAULT_EMAIL}
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_DEFAULT_PASSWORD}
    networks:
      - postgre
    volumes:
      - pgadmin_data:/var/lib/pgadmin/

volumes:
  redis_data:
  pgadmin_data:
  mariadb:
  postgre:

networks:
  redis:
  mariadb:
  postgre:
  tandoor:
    external: true
